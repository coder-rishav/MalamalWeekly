{% extends 'custom_admin/base.html' %}

{% block title %}Dashboard - Admin Panel{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<style>
/* Masonry Grid Layout */
.masonry-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    grid-auto-rows: 10px;
    gap: 20px;
}

.masonry-item {
    break-inside: avoid;
    margin-bottom: 0;
}

/* Calculate grid row span based on content height */
.masonry-item-1 { grid-row-end: span 20; } /* Small cards */
.masonry-item-2 { grid-row-end: span 35; } /* Medium cards */
.masonry-item-3 { grid-row-end: span 50; } /* Large cards */
.masonry-item-4 { grid-row-end: span 70; } /* Extra large cards */
.masonry-item-chart { grid-row-end: span 45; } /* Chart cards with proper height */

@media (min-width: 768px) {
    .masonry-container {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 992px) {
    .masonry-container {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 1400px) {
    .masonry-container {
        grid-template-columns: repeat(4, 1fr);
    }
}
</style>

<!-- Statistics Cards Row 1 -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Total Users</p>
                        <h3 class="mb-0">{{ total_users }}</h3>
                        <small class="text-success"><i class="bi bi-arrow-up"></i> {{ new_users_count }} new (30d)</small>
                    </div>
                    <i class="bi bi-people text-primary" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Active Games</p>
                        <h3 class="mb-0">{{ active_games }}/{{ total_games }}</h3>
                    </div>
                    <i class="bi bi-controller text-success" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Pending Deposits</p>
                        <h3 class="mb-0">{{ pending_deposits }}</h3>
                    </div>
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Pending Withdrawals</p>
                        <h3 class="mb-0">{{ pending_withdrawals }}</h3>
                    </div>
                    <i class="bi bi-cash-coin text-danger" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards Row 2 (New Features) -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-info">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Pending KYC</p>
                        <h3 class="mb-0">{{ kyc_pending }}</h3>
                        <small class="text-muted">{{ kyc_verified }} verified</small>
                    </div>
                    <i class="bi bi-shield-check text-info" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-secondary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Ban Appeals</p>
                        <h3 class="mb-0">{{ pending_appeals }}</h3>
                        <small class="text-muted">{{ approved_appeals }} approved</small>
                    </div>
                    <i class="bi bi-envelope-exclamation text-secondary" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Payment Gateways</p>
                        <h3 class="mb-0">{{ active_gateways }}/{{ total_gateways }}</h3>
                        <small class="text-muted">Active</small>
                    </div>
                    <i class="bi bi-credit-card text-primary" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">CMS Pages</p>
                        <h3 class="mb-0">{{ active_pages }}/{{ total_pages }}</h3>
                        <small class="text-muted">Published</small>
                    </div>
                    <i class="bi bi-file-text text-success" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial Overview -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Total Deposits</h6>
                <h2 class="text-success">₹{{ total_deposits|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Total Withdrawals</h6>
                <h2 class="text-danger">₹{{ total_withdrawals|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Game Entries</h6>
                <h2 class="text-primary">₹{{ total_game_entries|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <!-- Transaction Trends Chart -->
    <div class="col-md-8 mb-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Transaction Trends (Last 7 Days)</h5>
            </div>
            <div class="card-body">
                <canvas id="transactionChart" style="height: 300px; max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    
    <!-- KYC Status Chart -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> KYC Status</h5>
            </div>
            <div class="card-body">
                <canvas id="kycChart" style="max-height: 250px;"></canvas>
                <div class="mt-3">
                    <small class="d-block"><span class="badge bg-warning">{{ kyc_pending }}</span> Pending</small>
                    <small class="d-block"><span class="badge bg-success">{{ kyc_verified }}</span> Verified</small>
                    <small class="d-block"><span class="badge bg-danger">{{ kyc_rejected }}</span> Rejected</small>
                    <small class="d-block"><span class="badge bg-secondary">{{ kyc_not_submitted }}</span> Not Submitted</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{% url 'custom_admin:deposit_requests' %}" class="btn btn-warning me-2 mb-2">
                    <i class="bi bi-inbox"></i> Review Deposits ({{ pending_deposits }})
                </a>
                <a href="{% url 'custom_admin:withdrawal_requests' %}" class="btn btn-info me-2 mb-2">
                    <i class="bi bi-cash"></i> Review Withdrawals ({{ pending_withdrawals }})
                </a>
                <a href="{% url 'custom_admin:kyc_requests_list' %}" class="btn btn-primary me-2 mb-2">
                    <i class="bi bi-shield-check"></i> Review KYC ({{ kyc_pending }})
                </a>
                <a href="{% url 'custom_admin:ban_appeals_list' %}?status=pending" class="btn btn-secondary me-2 mb-2">
                    <i class="bi bi-envelope-exclamation"></i> Ban Appeals ({{ pending_appeals }})
                </a>
                <a href="{% url 'custom_admin:users_list' %}" class="btn btn-dark me-2 mb-2">
                    <i class="bi bi-people"></i> Manage Users
                </a>
                <a href="{% url 'custom_admin:games_management' %}" class="btn btn-success me-2 mb-2">
                    <i class="bi bi-controller"></i> Manage Games
                </a>
                <a href="{% url 'custom_admin:payment_gateways_list' %}" class="btn btn-info me-2 mb-2">
                    <i class="bi bi-credit-card"></i> Payment Gateways
                </a>
                <a href="{% url 'custom_admin:cms_pages_list' %}" class="btn btn-success mb-2">
                    <i class="bi bi-file-text"></i> CMS Pages
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Masonry Grid Container -->
<div class="masonry-container">
    <!-- Recent KYC Submissions -->
    <div class="masonry-item masonry-item-3">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Recent KYC</h5>
            </div>
            <div class="card-body">
                {% if recent_kyc %}
                <div class="list-group">
                    {% for profile in recent_kyc %}
                    <a href="{% url 'custom_admin:kyc_review' profile.user.id %}" class="list-group-item list-group-item-action">
                        <div class="d-flex align-items-center">
                            {% if profile.profile_photo %}
                            <img src="{{ profile.profile_photo.url }}" alt="{{ profile.user.username }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                            {% else %}
                            <i class="bi bi-person-circle me-2" style="font-size: 2rem;"></i>
                            {% endif %}
                            <div>
                                <strong>{{ profile.user.username }}</strong>
                                <br><small class="text-muted">{{ profile.kyc_submitted_at|timesince }} ago</small>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No pending KYC</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Active Rounds -->
    <div class="masonry-item masonry-item-3">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-play-circle"></i> Active Rounds</h5>
            </div>
            <div class="card-body">
                {% if active_rounds %}
                <div class="list-group">
                    {% for round in active_rounds %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ round.game.name }}</strong>
                                <br><small class="text-muted">Round #{{ round.round_number }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">{{ round.total_participants }} players</span>
                                <br><small class="text-muted">₹{{ round.total_pool_amount }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No active rounds</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="masonry-item masonry-item-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-receipt"></i> Recent Transactions</h5>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                <div class="list-group">
                    {% for transaction in recent_transactions %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ transaction.user.username }}</strong>
                                <br><small class="text-muted">{{ transaction.get_transaction_type_display }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge 
                                    {% if transaction.transaction_type == 'deposit' %}bg-success
                                    {% elif transaction.transaction_type == 'withdrawal' %}bg-danger
                                    {% else %}bg-info{% endif %}">
                                    ₹{{ transaction.amount }}
                                </span>
                                <br><small class="text-muted">{{ transaction.created_at|timesince }} ago</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No transactions yet</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Game Entries -->
    <div class="masonry-item masonry-item-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-joystick"></i> Recent Game Entries</h5>
            </div>
            <div class="card-body">
                {% if recent_entries %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Game</th>
                                <th>Round</th>
                                <th>Entry Number</th>
                                <th>Fee</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in recent_entries %}
                            <tr>
                                <td><strong>{{ entry.user.username }}</strong></td>
                                <td>{{ entry.game_round.game.name }}</td>
                                <td>#{{ entry.game_round.round_number }}</td>
                                <td><code>{{ entry.entry_number }}</code></td>
                                <td>₹{{ entry.entry_fee_paid }}</td>
                                <td><small>{{ entry.created_at|timesince }} ago</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No game entries yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- End Masonry Container -->

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Transaction Trends Chart
const transactionCtx = document.getElementById('transactionChart').getContext('2d');
const transactionData = {{ daily_transactions|safe }};

const transactionChart = new Chart(transactionCtx, {
    type: 'line',
    data: {
        labels: transactionData.map(d => d.date),
        datasets: [
            {
                label: 'Deposits',
                data: transactionData.map(d => d.deposits),
                borderColor: 'rgb(40, 167, 69)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
            },
            {
                label: 'Withdrawals',
                data: transactionData.map(d => d.withdrawals),
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            },
            {
                label: 'Game Entries',
                data: transactionData.map(d => d.game_entries),
                borderColor: 'rgb(0, 123, 255)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '₹' + value;
                    }
                }
            }
        }
    }
});

// KYC Status Pie Chart
const kycCtx = document.getElementById('kycChart').getContext('2d');
const kycChart = new Chart(kycCtx, {
    type: 'doughnut',
    data: {
        labels: ['Pending', 'Verified', 'Rejected', 'Not Submitted'],
        datasets: [{
            data: [{{ kyc_pending }}, {{ kyc_verified }}, {{ kyc_rejected }}, {{ kyc_not_submitted }}],
            backgroundColor: [
                'rgb(255, 193, 7)',
                'rgb(40, 167, 69)',
                'rgb(220, 53, 69)',
                'rgb(108, 117, 125)'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}
