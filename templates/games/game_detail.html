{% extends 'base.html' %}

{% block title %}{{ game.name }} - Malamal Weekly{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-controller"></i> {{ game.name }}</h4>
            </div>
            <div class="card-body">
                {% if game.image %}
                <img src="{{ game.image.url }}" alt="{{ game.name }}" class="img-fluid mb-3 rounded">
                {% endif %}
                
                <p class="lead">{{ game.description }}</p>
                
                <hr>
                
                <h5><i class="bi bi-book"></i> Game Rules</h5>
                <div style="white-space: pre-line;">{{ game.rules }}</div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="text-muted">Entry Fee</h6>
                                <h4 class="text-primary">{% load currency_tags %}{% format_user_amount game.entry_fee user %}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="text-muted">Prize</h6>
                                <h4 class="text-success">{% load currency_tags %}{% format_user_amount game.winning_amount user %}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="text-muted">Players</h6>
                                <h4>{{ game.min_participants }}-{{ game.max_participants }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="text-muted">Rounds</h6>
                                <h4>{{ game.total_rounds_played }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <!-- Active Round -->
        {% if active_round %}
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-play-circle"></i> Active Round</h5>
            </div>
            <div class="card-body">
                <h6>Round #{{ active_round.round_number }}</h6>
                <p><strong>Status:</strong> <span class="badge bg-{{ active_round.status }}">{{ active_round.get_status_display }}</span></p>
                
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-clock-history"></i> <strong>Entry Deadline:</strong><br>
                    {{ active_round.scheduled_end|date:"M d, Y" }} at {{ active_round.scheduled_end|date:"h:i A" }}<br>
                    <small class="badge bg-danger mt-1">{{ active_round.scheduled_end|timeuntil }} remaining</small>
                </div>
                
                <p><strong>Participants:</strong> {{ active_round.total_participants }}/{{ game.max_participants }}</p>
                <p><strong>Prize Pool:</strong> {% load currency_tags %}{% format_user_amount active_round.total_pool_amount user %}</p>
                
                {% if user_entry %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> You've entered this round!
                    <br><small>Entry: {{ user_entry.entry_number }}</small>
                </div>
                <a href="{% url 'games:my_entries' %}" class="btn btn-outline-primary w-100">
                    View My Entry
                </a>
                {% else %}
                <form method="post" action="{% url 'games:play_game' game.id active_round.id %}">
                    {% csrf_token %}
                    
                    {% if game.game_type == 'number_match' %}
                    <h6 class="mb-3">Select 5 Numbers (0-99)</h6>
                    <div class="alert alert-info mb-2">
                        <small><i class="bi bi-info-circle"></i> Click numbers to select. Pick exactly 5 numbers.</small>
                    </div>
                    <div id="number-match-selection-display" class="mb-3" style="background: #f8f9fa; padding: 8px; border-radius: 5px; border: 1px solid #dee2e6;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong style="font-size: 0.85rem;">Selected:</strong>
                            <span class="badge bg-primary"><span id="number-match-count">0</span>/5</span>
                        </div>
                        <div id="number-match-selected-numbers" style="font-size: 0.8rem; color: #495057; min-height: 20px;">
                            Click numbers below to select
                        </div>
                    </div>
                    <div id="number-match-grid" style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; padding: 5px; border: 1px solid #dee2e6; border-radius: 5px; background: #fff;">
                        {% for num in "0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789"|make_list %}
                        {% if forloop.counter0 <= 99 %}
                        <button type="button" class="btn btn-outline-primary number-match-number" data-number="{{ forloop.counter0 }}" style="padding: 4px 2px; font-size: 0.75rem; min-width: 0; aspect-ratio: 1;">
                            {{ forloop.counter0 }}
                        </button>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <input type="hidden" name="number_match_numbers_hidden" id="number-match-numbers-hidden" required>
                    
                    {% elif game.game_type == 'lucky_draw' %}
                    <h6 class="mb-3">Pick Your Lucky Number (1-100)</h6>
                    <div class="alert alert-info mb-2">
                        <small><i class="bi bi-info-circle"></i> Click a number to select your lucky number.</small>
                    </div>
                    <div id="lucky-draw-selection-display" class="mb-3" style="background: #f8f9fa; padding: 8px; border-radius: 5px; border: 1px solid #dee2e6;">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong style="font-size: 0.85rem;">Selected:</strong>
                            <span id="lucky-draw-selected-number" class="badge bg-primary" style="font-size: 0.9rem;">None</span>
                        </div>
                    </div>
                    <div id="lucky-draw-grid" style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; padding: 5px; border: 1px solid #dee2e6; border-radius: 5px; background: #fff;">
                        {% for num in "123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789X"|make_list %}
                        {% if forloop.counter <= 100 %}
                        <button type="button" class="btn btn-outline-warning lucky-draw-number" data-number="{{ forloop.counter }}" style="padding: 4px 2px; font-size: 0.75rem; min-width: 0; aspect-ratio: 1;">
                            {{ forloop.counter }}
                        </button>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <input type="hidden" name="number" id="lucky-draw-number-hidden" required>
                    
                    {% elif game.game_type == 'color_game' %}
                    <h6 class="mb-3">Choose Your Color</h6>
                    <select name="color" class="form-control" required>
                        <option value="">Select color...</option>
                        <option value="red">ðŸ”´ Red</option>
                        <option value="green">ðŸŸ¢ Green</option>
                        <option value="blue">ðŸ”µ Blue</option>
                        <option value="yellow">ðŸŸ¡ Yellow</option>
                    </select>
                    
                    {% elif game.game_type == 'keno' %}
                    <h6 class="mb-3">Pick Your Numbers (1-20 from 1-80)</h6>
                    <div class="alert alert-info mb-2">
                        <small><i class="bi bi-info-circle"></i> Click numbers to select. Pick 1-20 numbers.</small>
                    </div>
                    <div id="keno-selection-display" class="mb-3" style="background: #f8f9fa; padding: 8px; border-radius: 5px; border: 1px solid #dee2e6;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong style="font-size: 0.85rem;">Selected:</strong>
                            <span class="badge bg-primary"><span id="keno-count">0</span>/20</span>
                        </div>
                        <div id="keno-selected-numbers" style="font-size: 0.8rem; color: #495057; min-height: 20px;">
                            Click numbers below to select
                        </div>
                    </div>
                    <div id="keno-grid" style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; padding: 5px; border: 1px solid #dee2e6; border-radius: 5px; background: #fff;">
                        {% for num in "12345678901234567890123456789012345678901234567890123456789012345678901234567890"|make_list %}
                        {% if forloop.counter <= 80 %}
                        <button type="button" class="btn btn-outline-primary keno-number" data-number="{{ forloop.counter }}" style="padding: 4px 2px; font-size: 0.75rem; min-width: 0; aspect-ratio: 1;">
                            {{ forloop.counter }}
                        </button>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <input type="hidden" name="keno_numbers_hidden" id="keno-numbers-hidden" required>
                    
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const selectedNumbers = new Set();
                        const maxSelections = 20;
                        const buttons = document.querySelectorAll('.keno-number');
                        const countDisplay = document.getElementById('keno-count');
                        const selectedDisplay = document.getElementById('keno-selected-numbers');
                        const hiddenInput = document.getElementById('keno-numbers-hidden');
                        
                        buttons.forEach(button => {
                            button.addEventListener('click', function(e) {
                                e.preventDefault();
                                const number = this.dataset.number;
                                
                                if (selectedNumbers.has(number)) {
                                    // Deselect
                                    selectedNumbers.delete(number);
                                    this.classList.remove('active');
                                    this.classList.add('btn-outline-primary');
                                    this.classList.remove('btn-primary');
                                } else if (selectedNumbers.size < maxSelections) {
                                    // Select
                                    selectedNumbers.add(number);
                                    this.classList.add('active');
                                    this.classList.remove('btn-outline-primary');
                                    this.classList.add('btn-primary');
                                }
                                
                                // Update displays
                                countDisplay.textContent = selectedNumbers.size;
                                if (selectedNumbers.size > 0) {
                                    const sortedNumbers = Array.from(selectedNumbers).sort((a, b) => Number(a) - Number(b));
                                    // Display as individual badges
                                    selectedDisplay.innerHTML = sortedNumbers.map(num => 
                                        `<span class="badge bg-primary me-1 mb-1">${num}</span>`
                                    ).join('');
                                } else {
                                    selectedDisplay.textContent = 'Click numbers below to select';
                                }
                                
                                // Update hidden input
                                hiddenInput.value = Array.from(selectedNumbers).join(',');
                            });
                        });
                        
                        // Form submission handler
                        const form = document.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                // Create input fields for each selected number
                                selectedNumbers.forEach(num => {
                                    const input = document.createElement('input');
                                    input.type = 'hidden';
                                    input.name = 'keno_numbers';
                                    input.value = num;
                                    form.appendChild(input);
                                });
                            });
                        }
                    });
                    </script>
                    
                    {% elif game.game_type == 'odd_even' %}
                    <h6 class="mb-3">Will the number be Odd or Even?</h6>
                    <div class="alert alert-info mb-3">
                        <small><i class="bi bi-info-circle"></i> A number between 1-100 will be drawn. Predict if it's odd or even!</small>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <input type="radio" class="btn-check" name="prediction" value="odd" id="odd-radio" required>
                            <label class="btn btn-outline-primary w-100" for="odd-radio" style="padding: 30px 0;">
                                <i class="bi bi-1-circle" style="font-size: 2rem;"></i><br>
                                <strong>ODD</strong><br>
                                <small>1, 3, 5, 7...</small>
                            </label>
                        </div>
                        <div class="col-6">
                            <input type="radio" class="btn-check" name="prediction" value="even" id="even-radio" required>
                            <label class="btn btn-outline-success w-100" for="even-radio" style="padding: 30px 0;">
                                <i class="bi bi-2-circle" style="font-size: 2rem;"></i><br>
                                <strong>EVEN</strong><br>
                                <small>2, 4, 6, 8...</small>
                            </label>
                        </div>
                    </div>
                    
                    {% elif game.game_type == 'custom' %}
                    <h6 class="mb-3">{{ game.name }}</h6>
                    
                    {% if game.game_config.input_type == 'number' %}
                        {% for i in "0123456789"|slice:":"|slice:game.game_config.number_count %}
                        <div class="mb-2">
                            <input type="number" name="custom_number_{{ forloop.counter }}" class="form-control" 
                                   placeholder="Number {{ forloop.counter }}" 
                                   min="{{ game.game_config.min_value }}" 
                                   max="{{ game.game_config.max_value }}" required>
                        </div>
                        {% endfor %}
                        <small class="text-muted">Enter {{ game.game_config.number_count }} number(s) between {{ game.game_config.min_value }} and {{ game.game_config.max_value }}</small>
                    
                    {% elif game.game_config.input_type == 'choice' %}
                        {% if game.game_config.multiple_selection %}
                        <p class="small">Select {{ game.game_config.selection_count }} option(s):</p>
                        {% for choice in game.game_config.choices %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="custom_choice" value="{{ choice }}" id="choice_{{ forloop.counter }}">
                            <label class="form-check-label" for="choice_{{ forloop.counter }}">
                                {{ choice }}
                            </label>
                        </div>
                        {% endfor %}
                        {% else %}
                        <select name="custom_choice" class="form-control" required>
                            <option value="">Select your choice...</option>
                            {% for choice in game.game_config.choices %}
                            <option value="{{ choice }}">{{ choice }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    
                    {% elif game.game_config.input_type == 'text' %}
                        <textarea name="custom_text" class="form-control" rows="3" 
                                  placeholder="Enter your answer..." 
                                  minlength="{{ game.game_config.min_length }}" 
                                  maxlength="{{ game.game_config.max_length }}" required></textarea>
                        <small class="text-muted">Between {{ game.game_config.min_length }} and {{ game.game_config.max_length }} characters</small>
                    {% endif %}
                    {% endif %}
                    
                    <div class="alert alert-info mt-3">
                        <small>
                            <strong>Cost:</strong> {% load currency_tags %}{% format_user_amount game.entry_fee user %}<br>
                            <strong>Your Balance:</strong> {% format_user_amount user.profile.wallet_balance user %}
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100 mt-2">
                        <i class="bi bi-play-fill"></i> Enter Game
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="card mb-3">
            <div class="card-body text-center">
                <i class="bi bi-clock-history" style="font-size: 3rem; color: #ccc;"></i>
                <p class="text-muted mt-3">No active round at the moment.</p>
                <small>Check back later for new rounds!</small>
            </div>
        </div>
        {% endif %}
        
        <!-- Recent Winners -->
        {% if recent_winners %}
        <div class="card">
            <div class="card-header bg-warning">
                <h6 class="mb-0"><i class="bi bi-trophy"></i> Recent Winners</h6>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for winner in recent_winners %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>{{ winner.user.username }}</strong>
                            <span class="badge bg-success">â‚¹{{ winner.prize_amount }}</span>
                        </div>
                        <small class="text-muted">Round {{ winner.game_round.round_number }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Number Match Game (Select 5 numbers from 0-99)
document.addEventListener('DOMContentLoaded', function() {
    const selectedNumbers = new Set();
    const maxSelections = 5;
    const buttons = document.querySelectorAll('.number-match-number');
    const countDisplay = document.getElementById('number-match-count');
    const selectedDisplay = document.getElementById('number-match-selected-numbers');
    const hiddenInput = document.getElementById('number-match-numbers-hidden');
    
    if (buttons.length > 0) {
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const number = this.dataset.number;
                
                if (selectedNumbers.has(number)) {
                    // Deselect
                    selectedNumbers.delete(number);
                    this.classList.remove('active');
                    this.classList.add('btn-outline-primary');
                    this.classList.remove('btn-primary');
                } else if (selectedNumbers.size < maxSelections) {
                    // Select
                    selectedNumbers.add(number);
                    this.classList.add('active');
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                }
                
                // Update displays
                countDisplay.textContent = selectedNumbers.size;
                if (selectedNumbers.size > 0) {
                    const sortedNumbers = Array.from(selectedNumbers).sort((a, b) => Number(a) - Number(b));
                    selectedDisplay.innerHTML = sortedNumbers.map(num => 
                        `<span class="badge bg-primary me-1 mb-1">${num}</span>`
                    ).join('');
                } else {
                    selectedDisplay.textContent = 'Click numbers below to select';
                }
                
                // Update hidden input
                hiddenInput.value = Array.from(selectedNumbers).join(',');
            });
        });
        
        // Form submission handler
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (selectedNumbers.size !== maxSelections) {
                    e.preventDefault();
                    alert(`Please select exactly ${maxSelections} numbers.`);
                    return;
                }
                // Create input fields for each selected number
                const sortedNumbers = Array.from(selectedNumbers).sort((a, b) => Number(a) - Number(b));
                sortedNumbers.forEach((num, index) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = `number_${index + 1}`;
                    input.value = num;
                    form.appendChild(input);
                });
            });
        }
    }
});

// Lucky Draw Game (Select 1 number from 1-100)
document.addEventListener('DOMContentLoaded', function() {
    let selectedNumber = null;
    const buttons = document.querySelectorAll('.lucky-draw-number');
    const selectedDisplay = document.getElementById('lucky-draw-selected-number');
    const hiddenInput = document.getElementById('lucky-draw-number-hidden');
    
    if (buttons.length > 0) {
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const number = this.dataset.number;
                
                // Deselect previous selection
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('btn-outline-warning');
                    btn.classList.remove('btn-warning');
                });
                
                // Select this number
                selectedNumber = number;
                this.classList.add('active');
                this.classList.remove('btn-outline-warning');
                this.classList.add('btn-warning');
                
                // Update display
                selectedDisplay.textContent = number;
                
                // Update hidden input
                hiddenInput.value = number;
            });
        });
    }
});
</script>

{% endblock %}
